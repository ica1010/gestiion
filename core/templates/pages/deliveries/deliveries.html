{% extends 'base/base.html' %} {% load static %} {% block 'content' %}
<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <!-- start page title -->
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
            <h4 class="mb-sm-0">Orders</h4>

            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item">
                  <a href="javascript: void(0);">Ecommerce</a>
                </li>
                <li class="breadcrumb-item active">Orders</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
      <!-- end page title -->

      <div class="row">
        <div class="col-lg-12">
          <div class="card" id="orderList">
            <div class="card-header border-0">
              <div class="row align-items-center gy-3">
                <div class="col-sm">
                  <h5 class="card-title mb-0">Delivery History</h5>
                </div>
                <div class="col-sm-auto">
                  <div class="flex-shrink-0">
                      <div class="dropdown card-header-dropdown">
                          <div class="date-range-picker">
                              <form method="get" class="d-flex" style="gap: 05px;justify-content: center;align-items: center;">
                                  <label for="start-date" class="form-label m-0">From: </label>
                                  <input type="date" id="start-date" class="form-control" name="start-date" value="{{ start_date_i }}">
                                  
                                  <label for="end-date" class="form-label m-0">To: </label>
                                  <input type="date" id="end-date" class="form-control" name="end-date" value="{{ end_date_i}}">
                                  
                                  <button type="submit" id="submit-dates" class="btn btn-info">Filter</button>
                              </form>
                          </div>
                      </div>
                  </div>
              </div>
                <div class="col-sm-auto">
                  <div class="d-flex gap-1 flex-wrap">
                    <button type="button" class="btn btn-success add-btn" data-bs-toggle="modal" id="create-btn"
                      data-bs-target="#showModal">
                      <i class="ri-add-line align-bottom me-1"></i> Ajouter une 
                      Sortie
                    </button>
                    <button type="button" class="btn btn-info"  id="dwnldBtn" >
                      <i class="ri-file-download-line align-bottom me-1"></i>
                      Import
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-body pt-0">
              <div>
                <ul class="nav nav-tabs nav-tabs-custom nav-success mb-3" role="tablist"></ul>

                <div class="table-responsive table-card mb-1">
                  <table class="table table-nowrap align-middle" id="orderTable">
                    <thead class="text-muted table-light">
                      <tr class="text-uppercase">
                        <th scope="col" style="width: 25px">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="checkAll" value="option" />
                          </div>
                        </th>
                        <th 
                         data-sort="id">Delivery ID</th>
                        {% if admin %}
                        <th 
                         data-sort="customer_name">User</th>
                        {% endif %}
                        <th 
                         data-sort="customer_name">Service</th>
                         <th 
                         data-sort="customer_name">Burreau</th>
                        <th data-sort="date">Delivery Date</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody class="list form-check-all">
                      {% for delivery in deliveries %}
                      <tr>
                        <th scope="row">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="checkAll" value="option1" />
                          </div>
                        </th>
                        <td class="id">
                          <a href="{% url 'delivery' delivery.did  %}"
                            class="fw-medium link-primary">#{{delivery.did}}</a>
                        </td>
                        {% if admin %}
                        <td class="customer_name">
                          {% if request.user == delivery.user %}
                              Vous
                              {% else %}
                          {{delivery.user}}
                                  
                          {% endif %}
                        </td>
                        {% endif %}
                        <td class="customer_name">{{delivery.service}}</td>
                        <td class="customer_name">{{delivery.post}}</td>
                        <td class="date">{{delivery.date|date:"d M Y"}}</td>
                        <td>
                          <ul class="list-inline hstack gap-2 mb-0">
                            <li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover"
                              data-bs-placement="top" aria-label="View" data-bs-original-title="View">
                              <a href="{% url 'delivery' delivery.did  %}" class="text-primary d-inline-block">
                                <i class="ri-eye-fill fs-16"></i>
                              </a>
                            </li>
                            <li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover"
                              data-bs-placement="top" aria-label="Edit" data-bs-original-title="Edit">
                              <a href="#showModal" data-bs-toggle="modal"
                                class="text-primary d-inline-block edit-item-btn">
                                <i class="ri-pencil-fill fs-16"></i>
                              </a>
                            </li>
                          </ul>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  <div class="noresult" style="display: none">
                    <div class="text-center">
                      <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop"
                        colors="primary:#405189,secondary:#0ab39c" style="width: 75px; height: 75px"></lord-icon>
                      <h5 class="mt-2">Sorry! No Result Found</h5>
                      <p class="text-muted">
                        We've searched more than 150+ Orders We did not find any
                        orders for you search.
                      </p>
                    </div>
                  </div>
                </div>
                
              </div>
              <div class="modal fade" id="showModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-light p-3">
                      <h5 class="modal-title" id="exampleModalLabel">&nbsp;</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        id="close-modal"></button>
                    </div>
                    <form class="tablelist-form" autocomplete="off" action="{% url 'add_delivery'  %}" method="post">
                      {% csrf_token %}
                      <div class="modal-body">
                        <div class="mb-3">
                          <div class="row my-4" id="prod-form">
                            <div class="col-8">
                              <label for="payment-field" class="form-label">Article</label>
                              <select class="form-control" data-trigger="" name="product">
                                <option value="" selected disabled>
                                  Article
                                </option>
                                {% for product in products %}
                                <option value="{{product.title}}">
                                 ({{product.pid}}) {{product.title}}
                                </option>

                                {% endfor %}
                              </select>
                            </div>
                            <div class="col-4">
                              <label for="username" class="form-label">Quantity</label>
                              <input type="number" name="quantity" class="form-control" placeholder="Enter quantity" />
                            </div>
                          </div>
                          <div id="form-box"></div>
                          <div class="row">
                            <div class="mt-3">
                              <i class="ri ri-add-circle-line btn btn-primary" style="cursor: pointer"
                                onclick="dupliquerElement()"></i>
                            </div>
                          </div>
                        </div>
                        <div class="row gy-4 mb-3">
                          <div class="col-12">
                            <label for="post-field" class="form-label">Code sortie</label>
                            <input type="text" name="code" class="form-control" >
                          </div>
                        </div>
                        <div class="row gy-4 mb-3">
                          <div class="col-md-6">
                            <div>
                              <label for="service-field" class="form-label">Service</label>
                              <select id="id_service" class="form-control" name="service" required="">
                                <option value="">Service</option>
                                {% for service in services %}
                                <option value="{{ service.title }}">
                                  {{ service.title }}
                                </option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div>
                              <label for="post-field" class="form-label">Burreau</label>
                              <input type="text" name="post" class="form-control" >
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <div class="hstack gap-2 justify-content-end">
                          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                            Close
                          </button>
                          <button type="submit" class="btn btn-success" id="add-btn">
                            Add Order
                          </button>
                          <!-- <button type="button" class="btn btn-success" id="edit-btn">Update</button> -->
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- Modal -->
              <div class="modal fade flip" id="deleteOrder" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-body p-5 text-center">
                      <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
                        colors="primary:#405189,secondary:#f06548" style="width: 90px; height: 90px"></lord-icon>
                      <div class="mt-4 text-center">
                        <h4>You are about to delete a order ?</h4>
                        <p class="text-muted fs-15 mb-4">
                          Deleting your order will remove all of your
                          information from our database.
                        </p>
                        <div class="hstack gap-2 justify-content-center remove">
                          <button class="btn btn-link link-success fw-medium text-decoration-none"
                            id="deleteRecord-close" data-bs-dismiss="modal">
                            <i class="ri-close-line me-1 align-middle"></i>
                            Close
                          </button>
                          <button class="btn btn-danger" id="delete-record">
                            Yes, Delete It
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--end modal -->
            </div>
          </div>
          <div class="card-body card" id="pdfcontent">
            <!-- Table des sorties -->
            <div class="table-responsive table-card mb-1">
                <h1 class="p-3 text-center">Liste des Sorties  
                {% if start_date %}
                du {{ start_date|date:"d M Y"}} au {{ end_date|date:"d M Y" }}
                {% endif %}</h1>
                <table class="table align-middle" id="out">
                    <thead class="table-light text-muted">
                        <tr>
                            <th>Code Sortie</th>
                            <th>Fait par</th>
                            <th>Produits livrés</th>
                            <th>Service</th>
                            <th>Bureau</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody class="list form-check-all">
                        {% for delivery in deliveries %}
                        <tr>
                            <td>#{{ delivery.did }}</td>
                            <td>{{ delivery.user }}</td>
                            <td>
                                <ul>
                                    {% for item in deliveries_product %}
                                    {% if item.delivery.did == delivery.did %}
                                    <li>({{ item.product.pid }}) {{ item.product.title }} | Quantité: {{ item.quantity }}</li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>{{ delivery.service }}</td>
                            <td>{{ delivery.post }}</td>
                            <td>{{ delivery.date|date:"d M Y" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Fin de la table des sorties -->
        </div>
        </div>
        <!--end col-->
      </div>
      <!--end row-->
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->
</div>

<script>
  function dupliquerElement() {
    // Sélectionnez l'élément que vous souhaitez dupliquer
    var elementA = document.getElementById("prod-form");

    // Créez une copie de l'élément
    var cloneElement = elementA.cloneNode(true);

    // Ajoutez la copie à un conteneur dans le DOM
    var conteneurElements = document.getElementById("form-box");
    conteneurElements.appendChild(cloneElement);
  }

  $(document).ready(function () {
    $("#id_service").change(function () {
      var service_id = $(this).val();
      $("#id_post").empty();
      if (service_id) {
        $.ajax({
          url: "/get_posts/",
          data: { service_id: service_id },
          dataType: "json",
          success: function (data) {
            $.each(data.posts, function (key, value) {
              $("#id_post").append(
                $("<option>").text(value).attr("value", key)
              );
            });
          },
        });
      }
    });
  });
</script>

{% endblock %}